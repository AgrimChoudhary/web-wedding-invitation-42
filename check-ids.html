<!DOCTYPE html>
<html>
<head>
    <title>ID Debug - Custom vs UUID</title>
    <style>
        body { font-family: Arial; padding: 20px; background: #f5f5f5; }
        .box { background: white; padding: 20px; margin: 10px 0; border-radius: 8px; border: 2px solid #ddd; }
        .uuid { border-color: #28a745; background: #f8fff9; }
        .custom { border-color: #007bff; background: #f0f8ff; }
        .unknown { border-color: #ffc107; background: #fffbf0; }
        pre { background: #f8f9fa; padding: 10px; border-radius: 4px; overflow-x: auto; font-size: 12px; }
        .highlight { background: yellow; padding: 2px 4px; border-radius: 3px; }
        button { background: #007bff; color: white; border: none; padding: 10px 20px; border-radius: 4px; cursor: pointer; margin: 5px; }
    </style>
</head>
<body>
    <h1>üîç ID Type Debug Tool</h1>
    <p>‡§Ø‡§π tool ‡§¨‡§§‡§æ‡§è‡§ó‡§æ ‡§ï‡§ø ‡§Ü‡§™‡§ï‡•á URL ‡§Æ‡•á‡§Ç <strong>Custom IDs</strong> ‡§π‡•à‡§Ç ‡§Ø‡§æ <strong>UUIDs</strong></p>
    
    <div class="box">
        <h3>üìä Current URL Analysis</h3>
        <div id="current-url"></div>
    </div>

    <div class="box" id="event-id-box">
        <h3>üéØ Event ID Analysis</h3>
        <div id="event-id-analysis"></div>
    </div>

    <div class="box" id="guest-id-box">
        <h3>üë§ Guest ID Analysis</h3>
        <div id="guest-id-analysis"></div>
    </div>

    <div class="box">
        <h3>üì§ What Will Be Sent to Platform</h3>
        <div id="platform-data"></div>
    </div>

    <div class="box">
        <h3>üß™ Test Actual Wish Submission</h3>
        <button onclick="testRealSubmission()">Test Real Wish Submission</button>
        <div id="test-results"></div>
    </div>

    <script>
        // UUID format regex
        const UUID_REGEX = /^[0-9a-f]{8}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{12}$/i;

        function analyzeID(id, name) {
            if (!id) {
                return {
                    type: 'MISSING',
                    description: `‚ùå ${name} is missing`,
                    class: 'unknown'
                };
            }

            const isUUID = UUID_REGEX.test(id);
            
            if (isUUID) {
                return {
                    type: 'UUID',
                    description: `‚úÖ ${name} is UUID format`,
                    class: 'uuid',
                    details: 'Database ‡§Æ‡•á‡§Ç directly ‡§ï‡§æ‡§Æ ‡§ï‡§∞‡•á‡§ó‡§æ'
                };
            } else {
                return {
                    type: 'CUSTOM',
                    description: `üîµ ${name} is Custom ID format`,
                    class: 'custom',
                    details: 'Platform ‡§ï‡•ã UUID ‡§Æ‡•á‡§Ç resolve ‡§ï‡§∞‡§®‡§æ ‡§π‡•ã‡§ó‡§æ'
                };
            }
        }

        function updateAnalysis() {
            const urlParams = new URLSearchParams(window.location.search);
            const eventId = urlParams.get('eventId');
            const guestId = urlParams.get('guestId');
            const guestName = urlParams.get('guestName');

            // Current URL
            document.getElementById('current-url').innerHTML = `
                <strong>Current URL:</strong><br>
                <pre>${window.location.href}</pre>
            `;

            // Event ID Analysis
            const eventAnalysis = analyzeID(eventId, 'Event ID');
            const eventBox = document.getElementById('event-id-box');
            eventBox.className = `box ${eventAnalysis.class}`;
            
            document.getElementById('event-id-analysis').innerHTML = `
                <p><strong>${eventAnalysis.description}</strong></p>
                <p><strong>Value:</strong> <span class="highlight">${eventId || 'NOT FOUND'}</span></p>
                <p><strong>Type:</strong> ${eventAnalysis.type}</p>
                <p><strong>Length:</strong> ${eventId ? eventId.length : 0} characters</p>
                ${eventAnalysis.details ? `<p><strong>Note:</strong> ${eventAnalysis.details}</p>` : ''}
                ${eventId && eventAnalysis.type === 'UUID' ? 
                    '<p>‚úÖ ‡§Ø‡§π direct database ‡§Æ‡•á‡§Ç ‡§ï‡§æ‡§Æ ‡§ï‡§∞‡•á‡§ó‡§æ</p>' : 
                    eventId ? '<p>üîÑ Platform ‡§ï‡•ã ‡§á‡§∏‡•á UUID ‡§Æ‡•á‡§Ç convert ‡§ï‡§∞‡§®‡§æ ‡§π‡•ã‡§ó‡§æ</p>' : 
                    '<p>‚ùå Event ID missing - ‡§Ø‡§π‡•Ä main problem ‡§π‡•à!</p>'
                }
            `;

            // Guest ID Analysis  
            const guestAnalysis = analyzeID(guestId, 'Guest ID');
            const guestBox = document.getElementById('guest-id-box');
            guestBox.className = `box ${guestAnalysis.class}`;
            
            document.getElementById('guest-id-analysis').innerHTML = `
                <p><strong>${guestAnalysis.description}</strong></p>
                <p><strong>Value:</strong> <span class="highlight">${guestId || 'NOT FOUND'}</span></p>
                <p><strong>Type:</strong> ${guestAnalysis.type}</p>
                <p><strong>Length:</strong> ${guestId ? guestId.length : 0} characters</p>
                ${guestAnalysis.details ? `<p><strong>Note:</strong> ${guestAnalysis.details}</p>` : ''}
                ${guestId && guestAnalysis.type === 'UUID' ? 
                    '<p>‚úÖ ‡§Ø‡§π direct database ‡§Æ‡•á‡§Ç ‡§ï‡§æ‡§Æ ‡§ï‡§∞‡•á‡§ó‡§æ</p>' : 
                    guestId ? '<p>üîÑ Platform ‡§ï‡•ã ‡§á‡§∏‡•á UUID ‡§Æ‡•á‡§Ç convert ‡§ï‡§∞‡§®‡§æ ‡§π‡•ã‡§ó‡§æ</p>' : 
                    '<p>‚ùå Guest ID missing!</p>'
                }
            `;

            // Platform Data
            const wishData = {
                event_id: eventId,
                guest_id: guestId,
                guest_name: guestName,
                content: 'Sample wish content',
                image_data: null,
                image_filename: null,
                image_type: null
            };

            document.getElementById('platform-data').innerHTML = `
                <p><strong>‡§Ø‡§π data platform ‡§ï‡•ã ‡§≠‡•á‡§ú‡§æ ‡§ú‡§æ‡§è‡§ó‡§æ:</strong></p>
                <pre>${JSON.stringify(wishData, null, 2)}</pre>
                
                <h4>üìã Platform Processing Required:</h4>
                <ul>
                    <li><strong>Event ID:</strong> ${eventAnalysis.type === 'UUID' ? 
                        '‚úÖ Direct use' : 
                        eventAnalysis.type === 'CUSTOM' ? 
                        'üîÑ Resolve custom_event_id ‚Üí id' : 
                        '‚ùå Missing'
                    }</li>
                    <li><strong>Guest ID:</strong> ${guestAnalysis.type === 'UUID' ? 
                        '‚úÖ Direct use' : 
                        guestAnalysis.type === 'CUSTOM' ? 
                        'üîÑ Resolve custom_guest_id ‚Üí id' : 
                        '‚ùå Missing'
                    }</li>
                </ul>

                <h4>üéØ Expected Database Queries:</h4>
                ${eventAnalysis.type === 'CUSTOM' ? 
                    '<p>üîç SELECT id FROM events WHERE custom_event_id = \'' + eventId + '\'</p>' : 
                    eventAnalysis.type === 'UUID' ? 
                    '<p>‚úÖ Direct use in WHERE id = \'' + eventId + '\'</p>' : 
                    '<p>‚ùå No query possible - Event ID missing</p>'
                }
                ${guestAnalysis.type === 'CUSTOM' ? 
                    '<p>üîç SELECT id FROM guests WHERE custom_guest_id = \'' + guestId + '\'</p>' : 
                    guestAnalysis.type === 'UUID' ? 
                    '<p>‚úÖ Direct use in WHERE id = \'' + guestId + '\'</p>' : 
                    '<p>‚ùå No query possible - Guest ID missing</p>'
                }
            `;
        }

        function testRealSubmission() {
            const resultsDiv = document.getElementById('test-results');
            const urlParams = new URLSearchParams(window.location.search);
            
            const eventId = urlParams.get('eventId');
            const guestId = urlParams.get('guestId');
            const guestName = urlParams.get('guestName');

            resultsDiv.innerHTML = '<p>üß™ Testing real wish submission with current IDs...</p>';

            const testWishData = {
                event_id: eventId,
                guest_id: guestId,
                guest_name: guestName,
                content: 'Test wish from ID debug tool - ' + new Date().toISOString(),
                image_data: null,
                image_filename: null,
                image_type: null
            };

            console.log('üß™ REAL TEST - Sending wish data to platform:', testWishData);

            let html = '<h4>üöÄ Real Submission Test Results:</h4>';
            html += '<p><strong>Data being sent:</strong></p>';
            html += `<pre>${JSON.stringify({
                type: 'SUBMIT_NEW_WISH',
                payload: testWishData,
                timestamp: Date.now()
            }, null, 2)}</pre>`;

            if (eventId && guestId && guestName) {
                if (window.parent && window.parent !== window) {
                    html += '<p>üì° Sending REAL wish submission to platform...</p>';
                    
                    // Send real wish submission
                    window.parent.postMessage({
                        type: 'SUBMIT_NEW_WISH',
                        payload: testWishData,
                        timestamp: Date.now()
                    }, '*');
                    
                    html += '<p>‚úÖ Real message sent! Check:</p>';
                    html += '<ul>';
                    html += '<li>Platform console for processing logs</li>';
                    html += '<li>Database for wish entry</li>';
                    html += '<li>Toast message for result</li>';
                    html += '</ul>';
                } else {
                    html += '<p>‚ùå Not in iframe - cannot send to platform</p>';
                }
            } else {
                html += '<p>‚ùå Cannot send - missing required data</p>';
            }

            resultsDiv.innerHTML = html;
        }

        // Listen for platform responses
        window.addEventListener('message', function(event) {
            const resultsDiv = document.getElementById('test-results');
            const currentHTML = resultsDiv.innerHTML;
            
            if (event.data && event.data.type && (
                event.data.type === 'WISH_SUBMITTED_SUCCESS' || 
                event.data.type === 'WISH_SUBMITTED_ERROR'
            )) {
                const isSuccess = event.data.type === 'WISH_SUBMITTED_SUCCESS';
                resultsDiv.innerHTML = currentHTML + `
                    <div style="border: 2px solid ${isSuccess ? 'green' : 'red'}; padding: 10px; margin: 10px 0; border-radius: 5px; background: ${isSuccess ? '#f0fff0' : '#fff0f0'};">
                        <h4>${isSuccess ? '‚úÖ SUCCESS' : '‚ùå ERROR'} - Platform Response:</h4>
                        <pre>${JSON.stringify(event.data, null, 2)}</pre>
                        ${isSuccess ? 
                            '<p><strong>üéâ Wish submitted successfully! Check database for entry.</strong></p>' :
                            '<p><strong>‚ùå Submission failed. Error details above.</strong></p>'
                        }
                    </div>
                `;
            }
        });

        // Initialize
        updateAnalysis();
    </script>
</body>
</html>

