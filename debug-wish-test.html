<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Debug Wish Communication Test</title>
    <style>
        body { 
            font-family: Arial, sans-serif; 
            padding: 20px; 
            background: #f5f5f5; 
        }
        .test-box { 
            background: white; 
            border: 2px solid #ddd; 
            border-radius: 8px; 
            padding: 20px; 
            margin: 10px 0; 
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .success { border-color: #28a745; background: #f8fff9; }
        .error { border-color: #dc3545; background: #fff8f8; }
        .warning { border-color: #ffc107; background: #fffbf0; }
        button { 
            background: #007bff; 
            color: white; 
            border: none; 
            padding: 10px 20px; 
            border-radius: 4px; 
            cursor: pointer; 
            margin: 5px;
        }
        button:hover { background: #0056b3; }
        .log { 
            background: #f8f9fa; 
            border: 1px solid #e9ecef; 
            padding: 10px; 
            margin: 10px 0; 
            border-radius: 4px; 
            font-family: monospace; 
            font-size: 12px; 
            max-height: 200px; 
            overflow-y: auto;
        }
        #console-output { 
            background: #000; 
            color: #00ff00; 
            padding: 15px; 
            border-radius: 4px; 
            font-family: 'Courier New', monospace; 
            font-size: 11px;
            max-height: 300px; 
            overflow-y: auto;
        }
        .step { margin: 10px 0; padding: 10px; background: #e9ecef; border-radius: 4px; }
    </style>
</head>
<body>
    <h1>üß™ Wish Communication Debug Tool</h1>
    <p><strong>Instructions:</strong> Open this page in your template iframe to test wish communication.</p>
    
    <div class="test-box">
        <h2>üìç Step 1: Environment Check</h2>
        <div id="environment-check">
            <div class="step">
                <strong>Window Location:</strong> <span id="window-location"></span>
            </div>
            <div class="step">
                <strong>Parent Window:</strong> <span id="parent-check"></span>
            </div>
            <div class="step">
                <strong>URL Parameters:</strong> <span id="url-params"></span>
            </div>
        </div>
    </div>

    <div class="test-box">
        <h2>üì° Step 2: PostMessage Test</h2>
        <button onclick="testBasicPostMessage()">Test Basic PostMessage</button>
        <button onclick="testWishSubmission()">Test Wish Submission</button>
        <button onclick="clearLogs()">Clear Logs</button>
        <div id="postmessage-result" class="log"></div>
    </div>

    <div class="test-box">
        <h2>üìä Step 3: Real-time Console Logs</h2>
        <div id="console-output"></div>
    </div>

    <div class="test-box">
        <h2>üîç Step 4: Message Listener Status</h2>
        <div id="listener-status" class="log"></div>
    </div>

    <script>
        // Capture console logs
        const originalLog = console.log;
        const originalError = console.error;
        const originalWarn = console.warn;
        
        function addToConsole(type, message) {
            const output = document.getElementById('console-output');
            const timestamp = new Date().toLocaleTimeString();
            const color = type === 'error' ? '#ff6b6b' : type === 'warn' ? '#ffd93d' : '#00ff00';
            output.innerHTML += `<div style="color: ${color}">[${timestamp}] ${type.toUpperCase()}: ${message}</div>`;
            output.scrollTop = output.scrollHeight;
        }
        
        console.log = function(...args) {
            originalLog.apply(console, args);
            addToConsole('log', args.join(' '));
        };
        
        console.error = function(...args) {
            originalError.apply(console, args);
            addToConsole('error', args.join(' '));
        };
        
        console.warn = function(...args) {
            originalWarn.apply(console, args);
            addToConsole('warn', args.join(' '));
        };

        // Initialize environment check
        function initEnvironmentCheck() {
            document.getElementById('window-location').textContent = window.location.href;
            document.getElementById('parent-check').textContent = 
                window.parent !== window ? '‚úÖ Has parent window' : '‚ùå No parent window (direct access)';
            
            const urlParams = new URLSearchParams(window.location.search);
            const params = Array.from(urlParams.entries()).map(([key, value]) => `${key}=${value}`).join(', ');
            document.getElementById('url-params').textContent = params || 'None';
        }

        // Test basic postMessage
        function testBasicPostMessage() {
            console.log('üß™ Testing basic postMessage...');
            addToResult('Testing basic postMessage...');
            
            if (window.parent === window) {
                addToResult('‚ùå ERROR: No parent window found! This page must be loaded in an iframe.');
                return;
            }
            
            try {
                const testMessage = {
                    type: 'TEST_MESSAGE',
                    payload: { test: true, timestamp: Date.now() },
                    source: 'DEBUG_TOOL'
                };
                
                console.log('üì§ Sending test message:', testMessage);
                window.parent.postMessage(testMessage, '*');
                addToResult('‚úÖ Basic postMessage sent successfully');
                
                // Listen for response
                let responseReceived = false;
                const timeout = setTimeout(() => {
                    if (!responseReceived) {
                        addToResult('‚ö†Ô∏è WARNING: No response received from platform (this is normal for test message)');
                    }
                }, 3000);
                
                const responseHandler = (event) => {
                    if (event.data && event.data.type && event.data.type.includes('TEST')) {
                        responseReceived = true;
                        clearTimeout(timeout);
                        addToResult('‚úÖ Response received from platform: ' + JSON.stringify(event.data));
                        window.removeEventListener('message', responseHandler);
                    }
                };
                
                window.addEventListener('message', responseHandler);
                
            } catch (error) {
                console.error('‚ùå PostMessage error:', error);
                addToResult('‚ùå ERROR: ' + error.message);
            }
        }

        // Test wish submission
        function testWishSubmission() {
            console.log('üéÅ Testing wish submission...');
            addToResult('Testing wish submission...');
            
            if (window.parent === window) {
                addToResult('‚ùå ERROR: No parent window found! This page must be loaded in an iframe.');
                return;
            }
            
            // Get URL parameters for guest info
            const urlParams = new URLSearchParams(window.location.search);
            const guestId = urlParams.get('guestId') || 'test-guest-123';
            const guestName = urlParams.get('guestName') || 'Test Guest';
            const eventId = urlParams.get('eventId') || 'test-event-123';
            
            console.log('üîç Using parameters:', { guestId, guestName, eventId });
            addToResult(`Using: Event ID: ${eventId}, Guest ID: ${guestId}, Guest Name: ${guestName}`);
            
            try {
                const wishData = {
                    guest_id: guestId,
                    guest_name: guestName,
                    content: 'Test wish from debug tool - ' + new Date().toISOString(),
                    image_data: null,
                    image_filename: null,
                    image_type: null
                };
                
                const wishMessage = {
                    type: 'SUBMIT_NEW_WISH',
                    payload: wishData,
                    timestamp: Date.now(),
                    source: 'DEBUG_TOOL'
                };
                
                console.log('üì§ Sending wish message:', wishMessage);
                addToResult('üì§ Sending wish submission message...');
                
                // Set up response listener
                let responseReceived = false;
                const timeout = setTimeout(() => {
                    if (!responseReceived) {
                        addToResult('‚ùå TIMEOUT: No response received from platform within 10 seconds');
                        console.error('‚ùå Platform response timeout');
                    }
                }, 10000);
                
                const responseHandler = (event) => {
                    console.log('üì• Received message:', event.data);
                    
                    if (event.data && event.data.type) {
                        if (event.data.type === 'WISH_SUBMITTED_SUCCESS') {
                            responseReceived = true;
                            clearTimeout(timeout);
                            addToResult('‚úÖ SUCCESS: Wish submitted successfully!');
                            addToResult('üìä Response data: ' + JSON.stringify(event.data.payload, null, 2));
                            window.removeEventListener('message', responseHandler);
                        } else if (event.data.type === 'WISH_SUBMITTED_ERROR') {
                            responseReceived = true;
                            clearTimeout(timeout);
                            addToResult('‚ùå ERROR: Platform returned error: ' + (event.data.payload?.error || 'Unknown error'));
                            addToResult('üìä Error details: ' + JSON.stringify(event.data.payload, null, 2));
                            window.removeEventListener('message', responseHandler);
                        }
                    }
                };
                
                window.addEventListener('message', responseHandler);
                
                // Send the message
                window.parent.postMessage(wishMessage, '*');
                addToResult('üì° Message sent, waiting for response...');
                
            } catch (error) {
                console.error('‚ùå Wish submission error:', error);
                addToResult('‚ùå ERROR: ' + error.message);
            }
        }

        // Add result to log
        function addToResult(message) {
            const result = document.getElementById('postmessage-result');
            const timestamp = new Date().toLocaleTimeString();
            result.innerHTML += `<div>[${timestamp}] ${message}</div>`;
            result.scrollTop = result.scrollHeight;
        }

        // Clear logs
        function clearLogs() {
            document.getElementById('postmessage-result').innerHTML = '';
            document.getElementById('console-output').innerHTML = '';
        }

        // Monitor message listener
        function monitorMessageListener() {
            let messageCount = 0;
            
            const originalAddEventListener = window.addEventListener;
            window.addEventListener = function(type, listener, options) {
                if (type === 'message') {
                    messageCount++;
                    updateListenerStatus();
                }
                return originalAddEventListener.call(this, type, listener, options);
            };
            
            function updateListenerStatus() {
                const status = document.getElementById('listener-status');
                status.innerHTML = `
                    <div>‚úÖ Message listeners registered: ${messageCount}</div>
                    <div>‚è∞ Last updated: ${new Date().toLocaleTimeString()}</div>
                `;
            }
            
            updateListenerStatus();
        }

        // Initialize when page loads
        document.addEventListener('DOMContentLoaded', function() {
            console.log('üß™ Debug tool initialized');
            initEnvironmentCheck();
            monitorMessageListener();
            
            // Test if we're in an iframe
            if (window.parent === window) {
                document.body.style.border = '3px solid red';
                document.body.insertAdjacentHTML('afterbegin', 
                    '<div style="background: #ffebee; color: #c62828; padding: 15px; margin-bottom: 20px; border-radius: 4px;">' +
                    '<strong>‚ö†Ô∏è WARNING:</strong> This debug tool must be opened within the platform iframe to work correctly!' +
                    '</div>'
                );
            }
        });
    </script>
</body>
</html>
